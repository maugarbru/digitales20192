<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <link src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.css" rel="stylesheet" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Equipo 1 | Digitales</title>
</head>

<body>
  <div id="app">
    <v-app>
      <v-content>
        <v-toolbar color="red" fixed>
          <v-toolbar-title class="white--text">Consumo de máquinas</v-toolbar-title>

          <div class="flex-grow-1"></div>
          <!-- v-if="$vuetify.breakpoint.smAndUp" -->
          <v-toolbar-items>
            <v-btn icon :href="base+'about'">
              <v-icon>mdi-information-variant</v-icon>
            </v-btn>
            <v-btn icon :href="base+'login'">
              <v-icon>mdi-account-details</v-icon>
            </v-btn>
          </v-toolbar-items>
        </v-toolbar>
        <v-container>
          <v-card class="mx-auto" max-width="450" tile>
            <v-card-title>Reportes de consumo</v-card-title>
            <br>
            <v-card-text>
              <v-form>
                <v-select v-model="maquinaEscogida" :items="maquinasNombres" label="Máquina" color="red" outlined></v-select>
                <v-select v-model="periodoEscogido" :items="periodos" label="Tiempo" color="red" outlined></v-select>
                <center v-if="periodoEscogido == 'Día'">
                  <v-date-picker v-model="dia" color="red" locale="es" :max="diaHoy"></v-date-picker>
                </center>
                <center v-if="periodoEscogido == 'Período'">
                  <h3>Escoger 2 días</h3>
                  <v-date-picker v-model="semana" range color="red" locale="es" :max="diaHoy">
                  </v-date-picker>
                </center>
                <center v-if="periodoEscogido == 'Mes'">
                  <v-date-picker v-model="mes" color="red" type="month" :max="mesHoy" locale="es">
                  </v-date-picker>
                </center>
                <br>
                <center>
                  <v-btn color="red" dark tile @click="comprobar()">Ver Reporte</v-btn>
                  <v-btn @click="limpiarCampos()" tile text outlined>Limpiar</v-btn>
                </center>
              </v-form>
            </v-card-text>
          </v-card>
          <br>
          <v-dialog v-model="dialog" fullscreen hide-overlay transition="dialog-bottom-transition">
            <v-card>
              <v-toolbar dark color="red">
                <v-btn icon dark @click="dialog = false">
                  <v-icon>mdi-close</v-icon>
                </v-btn>
                <v-toolbar-title>Consulta</v-toolbar-title>
                <v-spacer></v-spacer>
                <v-progress-circular v-if="loading" :width="3" indeterminate color="white">
                </v-progress-circular>
                <v-btn dark text v-if="!loading" @click="dialog = false">OK</v-btn>
              </v-toolbar>
              <br>
              <v-card-text>
                <p>Máquina: {{maquinaEscogida}}</p>
                <p v-if="periodoEscogido == 'Día'">Día escogido: {{dia}}</p>
                <p v-if="periodoEscogido == 'Mes'">Mes escogido: {{mes}}</p>
                <p v-if="periodoEscogido == 'Semana'">Periodo escogido: {{semana}}</p>

                <br />
                <h3 class="pb-2">Tabla de consumo</h3>
                <v-data-table :headers="headers" :items="datos" :items-per-page="5" class="elevation-1"
                  :loading="loading">
                </v-data-table>
                <h3 class="py-2">Grafica de consumo</h3>
                <canvas id="myChart"></canvas>
              </v-card-text>
            </v-card>
            <v-dialog>
        </v-container>
      </v-content>
    </v-app>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="https://rawgit.com/moment/moment/2.2.1/min/moment.min.js"></script>
  <!-- <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const app = new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      beforeMount() {
        this.getMaquinas()
      },
      data: {
        dialog: false,
        base: "/equipo1-nodejs/",  // base de la url en el servidor
        // base: "/", // base de la url localmente
        loading: false,
        show: false,
        consumos: [],
        labels: [],
        diaHoy: moment(new Date()).format("YYYY-MM-DD"),
        mesHoy: moment(new Date()).format("YYYY-MM"),
        dia: moment(new Date()).format("YYYY-MM-DD"),
        mes: moment(new Date()).format("YYYY-MM"),
        semana: [],
        datos: [],
        periodoEscogido: "",
        maquinaEscogida: "",
        periodos: ['Día', 'Período', 'Mes'],
        maquinas: [],
        maquinasNombres: [],
        headers: [],
      },
      methods: {
        graph() {
          var ctx = document.getElementById('myChart');
          var myChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: this.labels,
              datasets: [{
                label: "Consumos",
                data: this.consumos,
                borderWidth: 1,
                borderColor: "red",
                fill: false,
              }]
            },
            options: {
              scales: {
                yAxes: [{
                  ticks: {
                    beginAtZero: true
                  }
                }]
              }
            }
          });
          
        },
        comprobar() {
          if (this.periodoEscogido == '' || this.maquinaEscogida == '') {
            alert("Escoger máquina y tiempo")
          } else if (this.periodoEscogido == 'Período' && this.semana.length != 2) {
            alert("Escoger 2 días")
          } else {
            this.dialog = true;
            this.datos = [];
            if (this.periodos[0] == this.periodoEscogido) {
              this.getDia();
            } else if (this.periodos[1] == this.periodoEscogido) {
              this.getSemana()
            } else if (this.periodos[2] == this.periodoEscogido) {
              this.getMes()
            }

          }
        },
        limpiarCampos() {
          this.periodoEscogido = ""
          this.maquinaEscogida = ""
          this.dia = moment(new Date()).format("YYYY-MM-DD")
          this.mes = moment(new Date()).format("YYYY-MM")
        },
        getMaquina() {
          var uid = undefined
          this.maquinas.forEach(element => {
            if (element.nombre == this.maquinaEscogida) {
              uid = element.uid
            }
          });
          return uid
        },

        /**
         * metodo que hace las consultas hacia el servidor
         */
        async getAllData(url) {
          this.loading = true
          var self = this
          var response = {}
          var uri = ""
          try {
            uri = "http://167.249.40.70/equipo1-nodejs/" + url
            response = await axios.get(uri, { timeout: 4000 })
          } catch (error) {
            try {
              uri = "http://172.60.2.149/equipo1-nodejs/" + url
              response = await axios.get(uri, { timeout: 4000 })
            } catch (error) {
              alert("Error de conexión. Intente más tarde");
            }
          }

          this.datos = response.data;
          this.show = true;
          self.loading = false;
          return response

        },
        /**
          * trae los datos por dia
          */
        async getDia() {
          var uid_maquina = this.getMaquina()
          console.log(uid_maquina);
          
          var url = "filtroDia?fecha=" + this.dia + "&uid=" + uid_maquina
          this.headers = [
            { text: 'Consumo', value: 'consumo' },
            { text: 'Hora Inicio', value: 'hora_inicio' },
            { text: 'Hora Final', value: 'hora_fin' },
          ]
          await this.getAllData(url)
          this.getConsumos()
          this.getLabels('this.labels.push(element.hora_fin.slice(11, 17))')
          this.graph()
        },

        // metodo que trae los datos por semana
        async getSemana() {
          this.semana.sort()
          var uid_maquina = this.getMaquina()
          var url = `filtroFecha?fecha_inicio=${this.semana[0]}&fecha_fin=${this.semana[1]}&uid=${uid_maquina}`
          await this.getAllData(url)
          this.headers = [
            { text: 'Dia', value: 'fecha' },
            { text: 'Consumo', value: 'consumo' },
          ]
          this.getConsumos()
          this.getLabels('this.labels.push(element.fecha)')
          this.graph()
        },

        //metodo que trae los datos por mes  
        async getMes() {
          var uid_maquina = this.getMaquina()
          var url = `filtroFecha?fecha_inicio=${this.mes}-01&fecha_fin=${this.mes}-30&uid=${uid_maquina}`
          await this.getAllData(url)
          this.headers = [
            { text: 'Dia', value: 'fecha' },
            { text: 'Consumo', value: 'consumo' },
          ]
          this.getConsumos()
          this.getLabels('this.labels.push(element.fecha)')
          this.graph()
        },

        /**
         * mapea los consumos y las horas finales
         * */
        getConsumos() {
          this.consumos = []
          this.datos.forEach(element => {
            this.consumos.push(element.consumo)
          });
        },
        // metodo que trae las etiquetas dependiendo del tipo de report
        getLabels(condition) {
          this.labels = []
          this.datos.forEach(element => {
            eval(condition)
          });
        },

        async getMaquinas() {
          var url = 'maquinas'
          await this.getAllData(url)
          this.datos.forEach(element => {
            this.maquinas.push(element)
            this.maquinasNombres.push(element.nombre)
          });
          this.datos = []
        }
      }
    })
  </script>
  <style>
    #app {
      font-family: 'Ubuntu', sans-serif;
    }
  </style>
</body>

</html>